// add.c
#include <stdio.h>

/*
  【このコードの位置づけ（自作CPU文脈での見方）】
  - これは「CPUが最低限できるべき計算（加算）とメモリへの読み書き、
    そして（厳密にはCPU外の）I/O呼び出し」をCで書いた最小例である。
  - 自作CPUの検証では、この種の短いCコードを
    (1) コンパイル→(2) アセンブリを見る→(3) 命令列が自作CPUで動くか
    という流れで、命令セット/実装の不足を洗い出すのに使うことが多い。
*/

/*
  【注意（C言語としての正しさ）】
  - 通常は main は int を返すのが標準的である（int main(void)）。
  - void main(void) は処理系によっては動くが、規格としては推奨されない。
*/

int a;  // グローバル変数a（プログラム全体で参照可能）
int b;  // グローバル変数b（プログラム全体で参照可能）
int c;  // グローバル変数c（プログラム全体で参照可能）

/*
  【自作CPU的に重要な点：グローバル変数】
  - a,b,c は「静的領域（.bss や .data）」に置かれることが多い。
  - つまり、実行時には
      - メモリ上の固定アドレス（リンカが配置）に a,b,c が存在し、
      - CPUは「メモリアクセス命令（load/store）」で読み書きする
    という形になる。
  - 自作CPUでCを動かす場合、まず「RAMに対する load/store が正しいか」
    がここで試されることが多い。
*/

int main(void) {
  /*
    a = 5; b = 7; c = a + b; は見た目は単純だが、
    CPU視点ではだいたい次の要素が必要になる。

    (A) 即値（5や7）をレジスタへロードする仕組み（immediate）
    (B) レジスタの値をメモリへ書き戻す仕組み（store）
    (C) メモリから値をロードしてくる仕組み（load）
    (D) 加算器（ALU add）でレジスタ同士を足す仕組み
    (E) 計算結果をメモリへ保存する仕組み（store）
  */

  a = 5;  // a(メモリ上の変数)に 5 を格納（storeが発生しやすい）
  b = 7;  // b(メモリ上の変数)に 7 を格納

  /*
    c = a + b;
    - aとbをメモリから読み出し（load）
    - ALUで加算（add）
    - 結果をcへ書き戻し（store）
    という一連の流れに展開されることが多い。

    ※ 最適化レベルやコンパイラによっては、レジスタに保持して
       メモリアクセス回数を減らす場合もある。
       ただ「グローバル」は保守的にメモリに書いたり読んだりしがちで、
       初学の自作CPU検証には逆に都合が良いこともある。
  */
  c = a + b;

  /*
    printf は通常「標準ライブラリ関数」なので、
    自作CPU上で動かすには、OS（またはランタイム）が必要になることが多い。

    自作CPU検証でありがちな選択肢：
    - (1) printfは使わず、メモリ上の c をデバッガで確認する
    - (2) 何らかのシリアル出力（UART）に書き込む自前関数に置き換える
    - (3) エミュレータ上だけ printf 相当をフックする（システムコール風）
  */
  printf("c = %d\n", c); // cを10進で表示（環境依存：OS/ランタイム/I/Oが要る）

  /*
    標準的なCでは main は int を返す。
    0 は「正常終了」を表す慣習。
    自作CPUでOSなしのベアメタルなら、returnしても戻り先が無いこともあり、
    無限ループにする実装もよくある。
  */
  return 0;
}

/*
  【自作CPUのテストとしてこれを使うなら】
  - まずは printf を外して、c の値が正しくメモリに入るかを見るとよい。
    例：c を特定アドレスに置く / メモリダンプで確認 / レジスタに残す等。

  - もし「命令セットの最小要件」を考えるなら、このコードだけでも
    おおむね以下が必要になりやすい：
    - 即値ロード（li/addi 相当）
    - load/store（lw/sw 相当）
    - add（レジスタ加算）
    - さらに関数呼び出し（printf）までやるなら
      - call/ret（jal/jr 等）
      - スタックポインタ管理
      - ABI（引数の渡し方、保存レジスタ規約）
      - 文字列リテラル（"c = %d\n"）の配置と参照
    などが一気に増える。
*/
